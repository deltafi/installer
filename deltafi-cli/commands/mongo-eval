#!/usr/bin/env bash

. "$DELTAFICLI_WORKDIR/common"

cli_help_command() {
  echo "
Command: mongo-eval

Usage:
  mongo-eval COMMAND

The COMMAND should be quoted and not contain any single quotes"
  exit 1
}

ARGS=($@)
[[ " ${ARGS[@]} " =~ " --help " ]] && cli_help_command
[[ ${#ARGS[@]} -lt 2 ]] && cli_help_command

EVAL=${ARGS[1]}
MONGODB_USERNAME_ENV='$MONGODB_EXTRA_USERNAMES'
MONGODB_PASSWORD_ENV='$MONGODB_EXTRA_PASSWORDS'

if _is_standalone; then
  docker exec -i deltafi-mongodb sh -c "mongosh -u ${MONGODB_USERNAME_ENV} --password ${MONGODB_PASSWORD_ENV} --eval '${EVAL}' deltafi"
else
  POD=$(${KUBECTL_BIN} get pod -l app.kubernetes.io/name=mongodb -o jsonpath="{.items[0].metadata.name}")
  ${KUBECTL_BIN} exec -i ${POD} --container mongodb -- sh -c "mongosh -u ${MONGODB_USERNAME_ENV} --password ${MONGODB_PASSWORD_ENV} --eval '${EVAL}' deltafi"
fi
